<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Redis分布式锁(spring-boot-klock-starter快速入门) | 日常bb</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-8621788234752924" async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8621788234752924" crossorigin="anonymous"></script>
    <meta name="description" content="一些技术，一些随想，一些资源收藏。">
    <meta name="keywords" content="后端技术,rcbb,个人博客">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#7b074b">
    
    <link rel="preload" href="/assets/css/0.styles.d40c2a0a.css" as="style"><link rel="preload" href="/assets/js/app.f183bd5e.js" as="script"><link rel="preload" href="/assets/js/2.ae7bab8c.js" as="script"><link rel="preload" href="/assets/js/19.0ee58fc9.js" as="script"><link rel="prefetch" href="/assets/js/10.d53102f6.js"><link rel="prefetch" href="/assets/js/11.646febf5.js"><link rel="prefetch" href="/assets/js/12.81887ce3.js"><link rel="prefetch" href="/assets/js/13.621637c0.js"><link rel="prefetch" href="/assets/js/14.0150f885.js"><link rel="prefetch" href="/assets/js/15.7f18f496.js"><link rel="prefetch" href="/assets/js/16.69fb7a46.js"><link rel="prefetch" href="/assets/js/17.4dfbd4bc.js"><link rel="prefetch" href="/assets/js/18.61b5564d.js"><link rel="prefetch" href="/assets/js/20.487616f8.js"><link rel="prefetch" href="/assets/js/21.90e70f27.js"><link rel="prefetch" href="/assets/js/22.d6b983de.js"><link rel="prefetch" href="/assets/js/23.cc82aeb0.js"><link rel="prefetch" href="/assets/js/24.7ac2bb62.js"><link rel="prefetch" href="/assets/js/25.d13a82d3.js"><link rel="prefetch" href="/assets/js/26.e45f9ab4.js"><link rel="prefetch" href="/assets/js/27.1740771b.js"><link rel="prefetch" href="/assets/js/28.4a9f641c.js"><link rel="prefetch" href="/assets/js/29.677e0d93.js"><link rel="prefetch" href="/assets/js/3.396601ce.js"><link rel="prefetch" href="/assets/js/30.b260e854.js"><link rel="prefetch" href="/assets/js/31.18d6e525.js"><link rel="prefetch" href="/assets/js/32.6ee41b9e.js"><link rel="prefetch" href="/assets/js/33.89a8e1fd.js"><link rel="prefetch" href="/assets/js/34.3397a4d5.js"><link rel="prefetch" href="/assets/js/35.2a92ff28.js"><link rel="prefetch" href="/assets/js/36.23517e3e.js"><link rel="prefetch" href="/assets/js/37.9b7ffa67.js"><link rel="prefetch" href="/assets/js/38.6312ab8f.js"><link rel="prefetch" href="/assets/js/39.6cb32187.js"><link rel="prefetch" href="/assets/js/4.910dd52c.js"><link rel="prefetch" href="/assets/js/40.6f4d84a4.js"><link rel="prefetch" href="/assets/js/41.c1153c1c.js"><link rel="prefetch" href="/assets/js/42.f49d51d4.js"><link rel="prefetch" href="/assets/js/43.0ca861fd.js"><link rel="prefetch" href="/assets/js/44.9f5da1c3.js"><link rel="prefetch" href="/assets/js/45.75034ebd.js"><link rel="prefetch" href="/assets/js/46.9c872dd5.js"><link rel="prefetch" href="/assets/js/47.5f47c069.js"><link rel="prefetch" href="/assets/js/48.987beed0.js"><link rel="prefetch" href="/assets/js/49.a36c3d68.js"><link rel="prefetch" href="/assets/js/5.6de11f6c.js"><link rel="prefetch" href="/assets/js/50.5216ae3c.js"><link rel="prefetch" href="/assets/js/51.baa5293d.js"><link rel="prefetch" href="/assets/js/52.46ad157e.js"><link rel="prefetch" href="/assets/js/53.a9608afc.js"><link rel="prefetch" href="/assets/js/54.3615fe8a.js"><link rel="prefetch" href="/assets/js/55.dad36e14.js"><link rel="prefetch" href="/assets/js/56.83ff2c57.js"><link rel="prefetch" href="/assets/js/57.078795e4.js"><link rel="prefetch" href="/assets/js/58.bb3569c8.js"><link rel="prefetch" href="/assets/js/59.8743b223.js"><link rel="prefetch" href="/assets/js/6.df915fd0.js"><link rel="prefetch" href="/assets/js/60.dedae8eb.js"><link rel="prefetch" href="/assets/js/61.f64cb96f.js"><link rel="prefetch" href="/assets/js/7.f5cd3055.js"><link rel="prefetch" href="/assets/js/8.70d400ff.js"><link rel="prefetch" href="/assets/js/9.32d1a32c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d40c2a0a.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="日常bb" class="logo"> <span class="site-name can-hide">日常bb</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/article/" class="nav-link">文章</a></div><div class="nav-item"><a href="/idea/" class="nav-link">冥思</a></div><div class="nav-item"><a href="/other/" class="nav-link">其他</a></div><div class="nav-item"><a href="/favorites/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/rcbb-cc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://rcbb-public.oss-cn-guangzhou.aliyuncs.com/avatar.jpg"> <div class="blogger-info"><h3>日常bb</h3> <span>想起来全是问题，做起来才有答案。</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/article/" class="nav-link">文章</a></div><div class="nav-item"><a href="/idea/" class="nav-link">冥思</a></div><div class="nav-item"><a href="/other/" class="nav-link">其他</a></div><div class="nav-item"><a href="/favorites/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/rcbb-cc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Redis</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/024464/" aria-current="page" class="active sidebar-link">Redis分布式锁(spring-boot-klock-starter快速入门)</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/024464/#快速开始" class="sidebar-link">快速开始</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/024464/#核心依赖" class="sidebar-link">核心依赖</a></li><li class="sidebar-sub-header level3"><a href="/pages/024464/#核心配置" class="sidebar-link">核心配置</a></li><li class="sidebar-sub-header level3"><a href="/pages/024464/#使用" class="sidebar-link">使用</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/024464/#klock-注解参数说明" class="sidebar-link">@Klock 注解参数说明</a></li><li class="sidebar-sub-header level2"><a href="/pages/024464/#测试使用" class="sidebar-link">测试使用</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/024464/#方法级加锁" class="sidebar-link">方法级加锁</a></li><li class="sidebar-sub-header level3"><a href="/pages/024464/#针对用户-变量级加锁" class="sidebar-link">针对用户/变量级加锁</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Spring</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>概念</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>容器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实战</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>AI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-8621788234752924"
     data-ad-slot="8498052873"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/article/#文章" data-v-06225672>文章</a></li><li data-v-06225672><a href="/article/#Redis" data-v-06225672>Redis</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://rcbb.cc/" target="_blank" title="作者" class="beLink" data-v-06225672>rcbb</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-07-22</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABH1JREFUSA3tVl1oHFUUPmdmd2ltklqbpJDiNnXFmgbFktho7YMPNiJSSZM0+CAYSkUELVhM6YuwIPpgoOKDqOBDC0XE2CQoNtQXBUFTTcCi+Wlh1V2TQExsUzcltd3M9Tt3ZjZzZ2fT+OJTL8yeM+eee757fmeJbq//KQL8X3DUSFOcfr7cRsRtxNQMWueeVzOkaITIGqQHNg5y8+jNW9ldM7A6nTpAjuolUikAwq7CE3WcM2RRDz+XGVgN3FptU/aUSlvq9Pa3iZ1+sgAqJyyAFqkipd9dqiwHF3P65YycLWc/6sqGrvoEoIp6DOFaX5h6+dnfjkWprwqsPk0dUGq5vySwDImC10KxFHgGL1SWoc92O3eVht09qdXNH11I2SsTsJYqMWzihqGMi+A+Garf3BAuuLI5oGlULyNfyB/HYNujwktOfRrMr5t77NmevqaUopx0grnKAyvVpmwUDB4x6FPXuGvYLTDwWsejwgtgkYKPqRJg8SV6xaiZ3ZTppGneS4yfH5/66fZSDHv+QZci/+h5c5UHtpy67JUqGppM0sh0Nc1dW6/N1W5Yoqat8/TU/VnadmdeW2PLLSyh0cvxBs3KbqTmwYPpxN4do/mzE8nEpvX/UMu2Wbp74zUAK5q6WkHns7V0eWkdPbPzd3rxkTGybadYySumVzhcaJFbs5UrEkQ/+CK8gF5dnh/6ciIZ73gwQ927L1IitoxKLXYP3SjYdOrHHfTZhRRlFyrorafPk20B3HPD1y2G3qKZME5Jcf3t/HUC13/8tSd++vqFveMUTwAUxSUFI1QekR1+bIze3D9MF2aq6cPvG72CgnldWCFqyRw3lwH8ZMerjTD9ElRO7Gv44wNpC90aASqGfVlz/Rx17srQ57/UU26hkhQqUB7dBR71WmzQhHUnblGmVOEw0jhbV1n9OlXUDCIRGaNV5Jp43N516fN7JmnTHdfp7Hgy0luO4aMhtkLL8Bi3bUWYvzh5Mn1dTxrL6QmGuRhGL/TiTTxRoEdTszSaq9GR0NGA3KdkOz3hqSV3MIDhQ5IVX/Ivx3umBti2es2h4eZby7x8br1rkf7Mo90AqC8aQ3sJeNzqFRu+vSANAQe3PL7l0HGOAdwDCeZYvNKeoZp1Qfs6Aipndh86HmFRi0LAnEO47wsqM6cdfjh3jBPUzhZy7nvlUfFsamED1VQt6aISHVymXZ/B2aCtIG8AI8xfobj2d3en1wWVhOeHELKmLQ1s211s88comkv4UCwWyF787mJdYXtNfhKAXVqnKTq8QZvGAGGOfaTo5pGZ/PwbUCr5+DPr/1J92JNHr9aOl/F3iI5+O1nfybsGxoimvZ3ViWSluDITw3P37mypheDIPY0tw7+O/5ApbkYw+zpfaUVu32Pi98+defdUhEpZkRFq0aqyNh9FuL9hpYbEm6iwi0z2REd09ZmyENEbuhjDWzKvZXTqKYaBIr3tt5kuPtQBZFvEUwHt60vfCNu41XsksH9Ij1BMMz1Y0OOunHNShFIP5868g5zeXmuLwL9T4b6Q2+KejgAAAABJRU5ErkJggg==">Redis分布式锁(spring-boot-klock-starter快速入门)<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="spring-boot-klock-starter"><a href="#spring-boot-klock-starter" class="header-anchor">#</a> spring-boot-klock-starter</h1> <p>基于 Redis 的分布式锁 spring-boot starter 组件，使得项目拥有分布式锁能力变得异常简单。</p> <p><a href="https://github.com/rcbb-cc/fast-start-guide" target="_blank" rel="noopener noreferrer">klock-demo Github地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="快速开始"><a href="#快速开始" class="header-anchor">#</a> 快速开始</h2> <p>SpringBoot 项目接入。</p> <h3 id="核心依赖"><a href="#核心依赖" class="header-anchor">#</a> 核心依赖</h3> <div class="language-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>cn.keking<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-klock-starter<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.4-RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="核心配置"><a href="#核心配置" class="header-anchor">#</a> 核心配置</h3> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">klock</span><span class="token punctuation">:</span>
    <span class="token key atrule">address</span><span class="token punctuation">:</span> 127.0.0.1<span class="token punctuation">:</span><span class="token number">6379</span> <span class="token comment">#redis链接地址</span>
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">2021</span> <span class="token comment">#redis密码</span>
    <span class="token key atrule">database</span><span class="token punctuation">:</span> <span class="token number">1</span> <span class="token comment">#redis数据索引</span>
    <span class="token key atrule">waitTime</span><span class="token punctuation">:</span> <span class="token number">60</span> <span class="token comment">#获取锁最长阻塞时间（默认：60，单位：秒）</span>
    <span class="token key atrule">leaseTime</span><span class="token punctuation">:</span> <span class="token number">60</span> <span class="token comment">#已获取锁后自动释放时间（默认：60，单位：秒）</span>
<span class="token comment">#    cluster-server:</span>
<span class="token comment">#      node-addresses: #redis集群配置 如 127.0.0.1:7000,127.0.0.1:7001，127.0.0.1:7002</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>spring.klock.address 和 spring.klock.cluster-server.node-addresses 选其一即可</p> <h3 id="使用"><a href="#使用" class="header-anchor">#</a> 使用</h3> <p>使用非常简单，在需要加分布式锁的方法上，添加注解 @Klock 即可。</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Klock</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> <span class="token function">list</span><span class="token punctuation">(</span><span class="token class-name">String</span> userName<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[&lt;{}&gt; 进入UserService.list() 成功获取锁]&quot;</span><span class="token punctuation">,</span> userName<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">User</span><span class="token punctuation">&gt;</span></span> list <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;Jack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">User</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setId</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;Tom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setAge</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;[&lt;{}&gt; UserService.list() 执行完毕，释放锁]&quot;</span><span class="token punctuation">,</span> userName<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> list<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h2 id="klock-注解参数说明"><a href="#klock-注解参数说明" class="header-anchor">#</a> @Klock 注解参数说明</h2> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * @author kl
 * @since 2017/12/29
 * Content :加锁注解
 */</span>
<span class="token annotation punctuation">@Target</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token class-name">ElementType</span><span class="token punctuation">.</span><span class="token constant">METHOD</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token annotation punctuation">@Retention</span><span class="token punctuation">(</span>value <span class="token operator">=</span> <span class="token class-name">RetentionPolicy</span><span class="token punctuation">.</span><span class="token constant">RUNTIME</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token annotation punctuation">@interface</span> <span class="token class-name">Klock</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 锁的名称 （对应redis的key值。默认为：类名+方法名）
     */</span>
    <span class="token class-name">String</span> <span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 锁类型（目前支持可重入锁，公平锁，读写锁。默认为：公平锁）
     */</span>
    <span class="token class-name">LockType</span> <span class="token function">lockType</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">LockType<span class="token punctuation">.</span>Reentrant</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     * 尝试加锁，最多等待时间（获取锁最长等待时间。默认为：60s。可通过spring.klock.waitTime统一配置）
     */</span>
    <span class="token keyword">long</span> <span class="token function">waitTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span>
    <span class="token comment">/**
     *上锁以后xxx秒自动解锁（获得锁后，自动释放锁的时间。默认为：60s。可通过spring.klock.leaseTime统一配置）
     */</span>
    <span class="token keyword">long</span> <span class="token function">leaseTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 自定义业务key
     */</span>
     <span class="token class-name">String</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>

     <span class="token comment">/**
     * 加锁超时的处理策略，可配置为不做处理、快速失败、阻塞等待的处理策略，默认策略为不做处理
     */</span>
     <span class="token class-name">LockTimeoutStrategy</span> <span class="token function">lockTimeoutStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">LockTimeoutStrategy</span><span class="token punctuation">.</span><span class="token constant">NO_OPERATION</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 自定义加锁超时的处理策略，需指定自定义处理的方法的方法名，并保持入参一致。
     */</span>
     <span class="token class-name">String</span> <span class="token function">customLockTimeoutStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

     <span class="token comment">/**
     * 释放锁时，持有的锁已超时的处理策略，可配置为不做处理、快速失败的处理策略，默认策略为不做处理
     */</span>
     <span class="token class-name">ReleaseTimeoutStrategy</span> <span class="token function">releaseTimeoutStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token class-name">ReleaseTimeoutStrategy</span><span class="token punctuation">.</span><span class="token constant">NO_OPERATION</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * 自定义释放锁时，需指定自定义处理的方法的方法名，并保持入参一致。
     */</span>
     <span class="token class-name">String</span> <span class="token function">customReleaseTimeoutStrategy</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">default</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h2 id="测试使用"><a href="#测试使用" class="header-anchor">#</a> 测试使用</h2> <p>源码地址：https://github.com/rcbb-cc/fast-start-guide</p> <h3 id="方法级加锁"><a href="#方法级加锁" class="header-anchor">#</a> 方法级加锁</h3> <p>核心代码如下图，最简单的使用，获取用户列表数据。</p> <p>Service 实现代码中会睡眠 10s。</p> <p><img src="https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2021/06/20210610153219-5e80ab.png?x-oss-process=style/yuantu_shuiyin" alt="核心代码"></p> <p>让 zhangsan、lisi 同一时间调用。</p> <blockquote><p>http://127.0.0.1:8081/user?userName=lisi</p></blockquote> <blockquote><p>http://127.0.0.1:8081/user?userName=zhangsan</p></blockquote> <p>zhangsan、lisi 几乎同时进入 Controller 中，但只有一个用户能进入的 Service 的方法中，当进入的这个用户执行完毕后，后面的用户才能进入。</p> <p><img src="https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2021/06/20210610153732-26a6e5.png?x-oss-process=style/yuantu_shuiyin" alt="执行结果"></p> <p>通过 Redis 可视化工具可以看到，有一个<code>lock.cc.rcbb.klock.test.service.UserServiceImpl.list</code>类名+方法名的 key，过期时间为默认的 60s。
<img src="https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2021/06/20210610154410-3382ba.png?x-oss-process=style/yuantu_shuiyin" alt="Redis显示结果"></p> <h3 id="针对用户-变量级加锁"><a href="#针对用户-变量级加锁" class="header-anchor">#</a> 针对用户/变量级加锁</h3> <p>核心代码如下图，根据 userId 获取该用户信息。</p> <p>关键点：<code>@Klock(keys = {&quot;#userId&quot;})</code> key 根据 userId 产生。</p> <p><img src="https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2021/06/20210610171646-075866.png?x-oss-process=style/yuantu_shuiyin" alt="根据userId获取该用户信"></p> <p>请求一：</p> <blockquote><p>http://127.0.0.1:8081/user/1</p></blockquote> <p>请求二：</p> <blockquote><p>http://127.0.0.1:8081/user/2</p></blockquote> <p>请求三：</p> <blockquote><p>http://127.0.0.1:8081/user/2</p></blockquote> <p>表现结果：请求一和请求二可同时进入 Service，但请求二和请求三无法同时进入 Service。</p> <p><img src="https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2021/06/20210610172551-d07ec7.png?x-oss-process=style/yuantu_shuiyin" alt="Redis显示结果"></p></div></div> <div class="page-slot page-slot-bottom"></br><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="auto"
     data-ad-client="ca-pub-8621788234752924"
     data-ad-slot="7043271566"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=Redis" title="标签">#Redis</a><a href="/tags/?tag=%E5%88%86%E5%B8%83%E5%BC%8F%E9%94%81" title="标签">#分布式锁</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">8/5/2022</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/112792/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">组合模式</div></a> <a href="/pages/f4535c/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">SpringBoot集成ShardingSphere4.1.1(自定义分库、分表算法)</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/112792/" class="prev">组合模式</a></span> <span class="next"><a href="/pages/f4535c/">SpringBoot集成ShardingSphere4.1.1(自定义分库、分表算法)</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/82530f/"><div>
            ChatGPT Plus订阅指南
            <!----></div></a> <span class="date">02-24</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/8b23f4/"><div>
            使用nvm控制node版本
            <!----></div></a> <span class="date">01-26</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/0e4b5e/"><div>
            git clone 报错：Filename too long
            <!----></div></a> <span class="date">01-26</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/rcbb-cc" title="Star我" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/playlist?id=5161366267" title="有品位的歌单" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2024
    <span>日常bb | <a href="https://beian.miit.gov.cn/" target="_blank" style="font-weight:normal">鄂ICP备17023998号</a> </span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/assets/js/app.f183bd5e.js" defer></script><script src="/assets/js/2.ae7bab8c.js" defer></script><script src="/assets/js/19.0ee58fc9.js" defer></script>
  </body>
</html>
