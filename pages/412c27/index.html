<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Security OAuth2自定义授权模式 | 日常bb</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-8621788234752924" async="true" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8621788234752924" crossorigin="anonymous"></script>
    <meta name="description" content="一些技术，一些随想，一些资源收藏。">
    <meta name="keywords" content="后端技术,rcbb,个人博客">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#7b074b">
    
    <link rel="preload" href="/assets/css/0.styles.d40c2a0a.css" as="style"><link rel="preload" href="/assets/js/app.f183bd5e.js" as="script"><link rel="preload" href="/assets/js/2.ae7bab8c.js" as="script"><link rel="preload" href="/assets/js/30.b260e854.js" as="script"><link rel="prefetch" href="/assets/js/10.d53102f6.js"><link rel="prefetch" href="/assets/js/11.646febf5.js"><link rel="prefetch" href="/assets/js/12.81887ce3.js"><link rel="prefetch" href="/assets/js/13.621637c0.js"><link rel="prefetch" href="/assets/js/14.0150f885.js"><link rel="prefetch" href="/assets/js/15.7f18f496.js"><link rel="prefetch" href="/assets/js/16.69fb7a46.js"><link rel="prefetch" href="/assets/js/17.4dfbd4bc.js"><link rel="prefetch" href="/assets/js/18.61b5564d.js"><link rel="prefetch" href="/assets/js/19.0ee58fc9.js"><link rel="prefetch" href="/assets/js/20.487616f8.js"><link rel="prefetch" href="/assets/js/21.90e70f27.js"><link rel="prefetch" href="/assets/js/22.d6b983de.js"><link rel="prefetch" href="/assets/js/23.cc82aeb0.js"><link rel="prefetch" href="/assets/js/24.7ac2bb62.js"><link rel="prefetch" href="/assets/js/25.d13a82d3.js"><link rel="prefetch" href="/assets/js/26.e45f9ab4.js"><link rel="prefetch" href="/assets/js/27.1740771b.js"><link rel="prefetch" href="/assets/js/28.4a9f641c.js"><link rel="prefetch" href="/assets/js/29.677e0d93.js"><link rel="prefetch" href="/assets/js/3.396601ce.js"><link rel="prefetch" href="/assets/js/31.18d6e525.js"><link rel="prefetch" href="/assets/js/32.6ee41b9e.js"><link rel="prefetch" href="/assets/js/33.89a8e1fd.js"><link rel="prefetch" href="/assets/js/34.3397a4d5.js"><link rel="prefetch" href="/assets/js/35.2a92ff28.js"><link rel="prefetch" href="/assets/js/36.23517e3e.js"><link rel="prefetch" href="/assets/js/37.9b7ffa67.js"><link rel="prefetch" href="/assets/js/38.6312ab8f.js"><link rel="prefetch" href="/assets/js/39.6cb32187.js"><link rel="prefetch" href="/assets/js/4.910dd52c.js"><link rel="prefetch" href="/assets/js/40.6f4d84a4.js"><link rel="prefetch" href="/assets/js/41.c1153c1c.js"><link rel="prefetch" href="/assets/js/42.f49d51d4.js"><link rel="prefetch" href="/assets/js/43.0ca861fd.js"><link rel="prefetch" href="/assets/js/44.9f5da1c3.js"><link rel="prefetch" href="/assets/js/45.75034ebd.js"><link rel="prefetch" href="/assets/js/46.9c872dd5.js"><link rel="prefetch" href="/assets/js/47.5f47c069.js"><link rel="prefetch" href="/assets/js/48.987beed0.js"><link rel="prefetch" href="/assets/js/49.a36c3d68.js"><link rel="prefetch" href="/assets/js/5.6de11f6c.js"><link rel="prefetch" href="/assets/js/50.5216ae3c.js"><link rel="prefetch" href="/assets/js/51.baa5293d.js"><link rel="prefetch" href="/assets/js/52.46ad157e.js"><link rel="prefetch" href="/assets/js/53.a9608afc.js"><link rel="prefetch" href="/assets/js/54.3615fe8a.js"><link rel="prefetch" href="/assets/js/55.dad36e14.js"><link rel="prefetch" href="/assets/js/56.83ff2c57.js"><link rel="prefetch" href="/assets/js/57.078795e4.js"><link rel="prefetch" href="/assets/js/58.bb3569c8.js"><link rel="prefetch" href="/assets/js/59.8743b223.js"><link rel="prefetch" href="/assets/js/6.df915fd0.js"><link rel="prefetch" href="/assets/js/60.dedae8eb.js"><link rel="prefetch" href="/assets/js/61.f64cb96f.js"><link rel="prefetch" href="/assets/js/7.f5cd3055.js"><link rel="prefetch" href="/assets/js/8.70d400ff.js"><link rel="prefetch" href="/assets/js/9.32d1a32c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.d40c2a0a.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="日常bb" class="logo"> <span class="site-name can-hide">日常bb</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/article/" class="nav-link">文章</a></div><div class="nav-item"><a href="/idea/" class="nav-link">冥思</a></div><div class="nav-item"><a href="/other/" class="nav-link">其他</a></div><div class="nav-item"><a href="/favorites/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/rcbb-cc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://rcbb-public.oss-cn-guangzhou.aliyuncs.com/avatar.jpg"> <div class="blogger-info"><h3>日常bb</h3> <span>想起来全是问题，做起来才有答案。</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><a href="/article/" class="nav-link">文章</a></div><div class="nav-item"><a href="/idea/" class="nav-link">冥思</a></div><div class="nav-item"><a href="/other/" class="nav-link">其他</a></div><div class="nav-item"><a href="/favorites/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/rcbb-cc" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Redis</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Spring</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>基础使用</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>Spring Security</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/32549d/" class="sidebar-link">Spring Security学习总结</a></li><li><a href="/pages/5fbd1a/" class="sidebar-link">Spring Security</a></li><li><a href="/pages/ffa63f/" class="sidebar-link">Spring Security OAuth2</a></li><li><a href="/pages/74390a/" class="sidebar-link">实战单体应用(认证授权服务+资源服务)</a></li><li><a href="/pages/0d4207/" class="sidebar-link">实战模块化(认证授权服务+资源服务)</a></li><li><a href="/pages/412c27/" aria-current="page" class="active sidebar-link">Spring Security OAuth2自定义授权模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/412c27/#验证码登录" class="sidebar-link">验证码登录</a></li><li class="sidebar-sub-header level2"><a href="/pages/412c27/#实现思路" class="sidebar-link">实现思路</a></li><li class="sidebar-sub-header level2"><a href="/pages/412c27/#验证码模式" class="sidebar-link">验证码模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/412c27/#_1、实现userdetailsservice" class="sidebar-link">1、实现UserDetailsService</a></li><li class="sidebar-sub-header level3"><a href="/pages/412c27/#_2、自定义authenticationtoken" class="sidebar-link">2、自定义AuthenticationToken</a></li><li class="sidebar-sub-header level3"><a href="/pages/412c27/#_3、自定义tokengranter" class="sidebar-link">3、自定义TokenGranter</a></li><li class="sidebar-sub-header level3"><a href="/pages/412c27/#_4、自定义authenticationprovider" class="sidebar-link">4、自定义AuthenticationProvider</a></li><li class="sidebar-sub-header level3"><a href="/pages/412c27/#_5、将自定义的provider注入容器" class="sidebar-link">5、将自定义的Provider注入容器</a></li><li class="sidebar-sub-header level3"><a href="/pages/412c27/#_6、加到compositetokengranter集合中" class="sidebar-link">6、加到CompositeTokenGranter集合中</a></li><li class="sidebar-sub-header level3"><a href="/pages/412c27/#_7、测试" class="sidebar-link">7、测试</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>收藏</span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>工具</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>概念</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>容器</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>实战</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>AI</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>前端</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-8621788234752924"
     data-ad-slot="8498052873"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/article/#文章" data-v-06225672>文章</a></li><li data-v-06225672><a href="/article/#Spring" data-v-06225672>Spring</a></li><li data-v-06225672><a href="/article/#Spring Security" data-v-06225672>Spring Security</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://rcbb.cc/" target="_blank" title="作者" class="beLink" data-v-06225672>rcbb</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2022-10-06</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">Spring Security OAuth2自定义授权模式<!----></h1>  <div class="theme-vdoing-content content__default"><h1 id="spring-security-oauth2自定义授权模式"><a href="#spring-security-oauth2自定义授权模式" class="header-anchor">#</a> Spring Security OAuth2自定义授权模式</h1> <p>在实际开发过程中<code>Spring Security OAuth2</code>默认提供的五种授权模式不够用的情况下，就需要我们自己来定义授权模式。</p> <p>例如国内比较常见的应用场景：短信验证码授权登录。</p> <p><a href="https://github.com/rcbb-cc/fast-start-guide" target="_blank" rel="noopener noreferrer">SpringSecurity-demo Github地址<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="验证码登录"><a href="#验证码登录" class="header-anchor">#</a> 验证码登录</h2> <p>其实实现这个需求有多种实现方式：</p> <p>第一种：写一个<code>controller</code>接收登录，逻辑通过则在<code>controller</code>中组装<code>token</code>。</p> <p>第二种：以<code>Spring Security</code>认证的思维，编写一个短信验证码的过滤器，配置在过滤器链上，加一个登录成功处理器，在登录成功后组装<code>token</code>。</p> <p>这两种写法都可以实现短信验证码登录的这个需求，但是都不太规范。</p> <p>规范写法：按照<code>Spring Security OAuth2</code>框架的的设计思想来完成自定义授权模式。</p> <p><code>Spring Security OAuth2</code>的授权思想和<code>Spring Security</code>有点区别：授权认证的时机不同。</p> <blockquote><p><code>Spring Security OAuth2</code>是在请求进入<code>controller</code>后得到请求参数，然后使用<code>Spring Security OAuth2</code>提供的一些内置组件完成<code>token</code>的生成，而<code>Spring Security</code>则是依赖过滤器链来实现的，<code>Spring Security</code>是在请求未到达<code>controller</code>时，被匹配的过滤器拦截，然后进行认证，生成<code>token</code>。</p></blockquote> <h2 id="实现思路"><a href="#实现思路" class="header-anchor">#</a> 实现思路</h2> <p>密码模式的授权流程：</p> <p><img src="https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221005135820-4acf6c.png?x-oss-process=style/yuantu_shuiyin" alt="密码模式的授权流程"></p> <p>重要知识点：</p> <ul><li>每种授权类型都对应一个实现类<code>TokenGranter</code></li> <li>所有<code>TokenGranter</code>实现类都通过<code>CompositeTokenGranter</code>中的<code>tokenGranters</code>集合存储</li> <li>通过判断<code>grantType</code>参数来定位具体使用哪个<code>TokenGranter</code>实现类来处理</li> <li>每种授权方式都对应一个<code>AuthenticationProvider</code></li> <li><code>TokenGranter</code>类会<code>new</code>一个<code>AuthenticationToken</code>实现类传递给<code>ProviderManager</code></li></ul> <p>所以自定义一个授权类型，必须构建自己的<code>TokenGranter</code>、<code>AuthenticationProvider</code>、<code>AuthenticationToken</code>。</p> <h2 id="验证码模式"><a href="#验证码模式" class="header-anchor">#</a> 验证码模式</h2> <h3 id="_1、实现userdetailsservice"><a href="#_1、实现userdetailsservice" class="header-anchor">#</a> 1、实现<code>UserDetailsService</code></h3> <p>后面主要填充的逻辑就是根据<code>phone</code>查询用户信息。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Service
public class SmsUserDetailsServiceImpl implements UserDetailsService {
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        return null;
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><h3 id="_2、自定义authenticationtoken"><a href="#_2、自定义authenticationtoken" class="header-anchor">#</a> 2、自定义<code>AuthenticationToken</code></h3> <p><code>SmsVerificationCodeAuthenticationToken</code>。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>public class SmsVerificationCodeAuthenticationToken extends AbstractAuthenticationToken {
    private final Object principal;

    public SmsVerificationCodeAuthenticationToken(Object principal) {
        super(null);
        this.principal = principal;
        setAuthenticated(false);
    }


    public SmsVerificationCodeAuthenticationToken(Object principal, Collection&lt;? extends GrantedAuthority&gt; authorities) {
        super(authorities);
        this.principal = principal;
        // 设置为已认证
        super.setAuthenticated(true);
    }

    @Override
    public Object getCredentials() {
        return null;
    }

    @Override
    public Object getPrincipal() {
        return this.principal;
    }

    public void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException {
        if (isAuthenticated) {
            throw new IllegalArgumentException( &quot;Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead&quot;);
        }
        super.setAuthenticated(false);
    }

    @Override
    public void eraseCredentials() {
        super.eraseCredentials();
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><h3 id="_3、自定义tokengranter"><a href="#_3、自定义tokengranter" class="header-anchor">#</a> 3、自定义<code>TokenGranter</code></h3> <p><code>SmsVerificationCodeTokenGranter</code>。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Slf4j
@Slf4j
public class SmsVerificationCodeTokenGranter extends AbstractTokenGranter {

    /**
     * 授权类型，和password是一样的作用
     */
    private static final String grantType = &quot;sms_code&quot;;

    private final AuthenticationManager authenticationManager;

    public SmsVerificationCodeTokenGranter(AuthenticationManager authenticationManager, AuthorizationServerTokenServices tokenServices, ClientDetailsService clientDetailsService, OAuth2RequestFactory requestFactory) {
        this(authenticationManager, tokenServices, clientDetailsService, requestFactory, grantType);
    }

    protected SmsVerificationCodeTokenGranter(AuthenticationManager authenticationManager, AuthorizationServerTokenServices tokenServices, ClientDetailsService clientDetailsService, OAuth2RequestFactory requestFactory, String grantType) {
        super(tokenServices, clientDetailsService, requestFactory, grantType);
        this.authenticationManager = authenticationManager;
    }

    @Override
    protected OAuth2Authentication getOAuth2Authentication(ClientDetails client, TokenRequest tokenRequest) {
        // 得到请求参数
        Map&lt;String, String&gt; parameters = new LinkedHashMap&lt;&gt;(tokenRequest.getRequestParameters());
        // 手机号
        String phone = parameters.get(&quot;phone&quot;);
        // 验证码
        String verificationCode = parameters.get(&quot;verification_code&quot;);
        log.info(&quot;[登录请求 phone&lt;{}&gt; verificationCode&lt;{}&gt;]&quot;, phone, verificationCode);
        
        Authentication userAuth = new SmsVerificationCodeAuthenticationToken(parameters);
        ((AbstractAuthenticationToken) userAuth).setDetails(parameters);
        try {
            // 调用authenticationManager进行认证，会根据SmsVerificationCodeAuthenticationToken找到对应的Provider
            userAuth = authenticationManager.authenticate(userAuth);
        } catch (AccountStatusException ase) {
            //covers expired, locked, disabled cases (mentioned in section 5.2, draft 31)
            throw new InvalidGrantException(ase.getMessage());
        } catch (BadCredentialsException e) {
            // If the username/password are wrong the spec says we should send 400/invalid grant
            throw new InvalidGrantException(e.getMessage());
        }
        if (userAuth == null || !userAuth.isAuthenticated()) {
            throw new InvalidGrantException(&quot;Could not authenticate user,phone number is: &quot; + phone);
        }
        OAuth2Request storedOAuth2Request = getRequestFactory().createOAuth2Request(client, tokenRequest);
        return new OAuth2Authentication(storedOAuth2Request, userAuth);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br></div></div><h3 id="_4、自定义authenticationprovider"><a href="#_4、自定义authenticationprovider" class="header-anchor">#</a> 4、自定义<code>AuthenticationProvider</code></h3> <p>这个类就是真正的处理类，经过<code>TokenGranter</code>后，会找到对应的<code>AuthenticationProvider</code>。</p> <p><code>SmsVerificationCodeAuthenticationProvider</code>。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Slf4j
public class SmsVerificationCodeAuthenticationProvider implements AuthenticationProvider {

    /**
     * 得到UserDetailsService对象用来获取用户信息
     */
    private UserDetailsService userDetailsService;

    public SmsVerificationCodeAuthenticationProvider(UserDetailsService userDetailsService) {
        this.userDetailsService = userDetailsService;
    }

    public void setUserDetailsService(UserDetailsService userDetailsService) {
        this.userDetailsService = userDetailsService;
    }

    /**
     * 过请求参数查询数据库用户信息，进行匹配
     *
     * @param authentication the authentication request object.
     * @return
     * @throws AuthenticationException
     */
    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        SmsVerificationCodeAuthenticationToken authenticationToken = (SmsVerificationCodeAuthenticationToken) authentication;
        Map&lt;String, String&gt; parameters = (Map&lt;String, String&gt;) authenticationToken.getPrincipal();
        log.info(&quot;[parameters &lt;{}&gt;]&quot;, parameters);
        // 手机号
        String phone = parameters.get(&quot;phone&quot;);
        // 验证码
        String verificationCode = parameters.get(&quot;verification_code&quot;);
        log.info(&quot;[登录请求 phone&lt;{}&gt; verificationCode&lt;{}&gt;]&quot;, phone, verificationCode);
        // 1.根据phone查询用户信息是否存在
        // 2.判断验证码 是否有效

        UserDetails user = new User(&quot;rcbb&quot;, &quot;rcbb&quot;, true, true, true, true,
                AuthorityUtils.commaSeparatedStringToAuthorityList(&quot;user_add,user_update,ROLE_ADMIN&quot;));

        SmsVerificationCodeAuthenticationToken smsVerificationCodeAuthenticationToken = new SmsVerificationCodeAuthenticationToken(user, user.getAuthorities());
        smsVerificationCodeAuthenticationToken.setDetails(authenticationToken.getDetails());
        return smsVerificationCodeAuthenticationToken;
    }

    @Override
    public boolean supports(Class&lt;?&gt; authentication) {
        // 判断authentication是否是SmsCodeAuthenticationToken类型
        return SmsVerificationCodeAuthenticationToken.class.isAssignableFrom(authentication);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br></div></div><h3 id="_5、将自定义的provider注入容器"><a href="#_5、将自定义的provider注入容器" class="header-anchor">#</a> 5、将自定义的<code>Provider</code>注入容器</h3> <p><code>SmsVerificationCodeAuthenticationConfig</code>。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Component
public class SmsVerificationCodeAuthenticationConfig extends SecurityConfigurerAdapter&lt;DefaultSecurityFilterChain, HttpSecurity&gt; {
    @Autowired
    private UserDetailsService userDetailsService;

    @Override
    public void configure(HttpSecurity builder) throws Exception {
        SmsVerificationCodeAuthenticationProvider provider = new SmsVerificationCodeAuthenticationProvider(userDetailsService);
        builder.authenticationProvider(provider);
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>在<code>WebSecurityConfig</code>中，注入自定义的授权配置类。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Configuration
@EnableWebSecurity
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {

    // 短信安全验证配置
    @Autowired
    private SmsVerificationCodeAuthenticationConfig smsVerificationCodeAuthenticationConfig;

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.apply(smsVerificationCodeAuthenticationConfig);
    }
    
    ...
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="_6、加到compositetokengranter集合中"><a href="#_6、加到compositetokengranter集合中" class="header-anchor">#</a> 6、加到<code>CompositeTokenGranter</code>集合中</h3> <p><code>clients</code>中的<code>authorizedGrantTypes</code>允许的授权类型添加<code>sms_code</code>。</p> <p>将自定义的授权类型加到集合<code>CompositeTokenGranter</code>中。</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>@Configuration
@EnableAuthorizationServer
public class AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter {

    @Override
    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {

        // 基于内存便于测试，使用in-memory存储
        clients.inMemory()
                // client_id
                .withClient(&quot;rcbb&quot;)
                // 未加密
                //.secret(&quot;secret&quot;)
                // 加密
                .secret(passwordEncoder.encode(&quot;rcbb&quot;))
                // 资源列表
                //.resourceIds(&quot;res1&quot;)
                // 该client允许的授权类型authorization_code,password,refresh_token,implicit,client_credentials
                .authorizedGrantTypes(&quot;authorization_code&quot;, &quot;password&quot;, &quot;client_credentials&quot;, &quot;implicit&quot;, &quot;refresh_token&quot;,&quot;sms_code&quot;)
                // 允许的授权范围
                .scopes(&quot;all&quot;, &quot;ROLE_ADMIN&quot;, &quot;ROLE_USER&quot;)
                // false跳转到授权页面
                //.autoApprove(false)
                //加上验证回调地址
                .redirectUris(&quot;http://rcbb.cc&quot;);
    }
    
    @Override
    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {
        List&lt;TokenGranter&gt; tokenGranters = new ArrayList&lt;&gt;(Collections.singleton(endpoints.getTokenGranter()));
        tokenGranters.add(new SmsVerificationCodeTokenGranter(authenticationManager, tokenService(), clientDetailsService, new DefaultOAuth2RequestFactory(clientDetailsService)));

        // 配置认证管理器
        endpoints.authenticationManager(authenticationManager)
                .tokenServices(tokenService())
                .tokenGranter(new CompositeTokenGranter(tokenGranters));
    }
}
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br></div></div><h3 id="_7、测试"><a href="#_7、测试" class="header-anchor">#</a> 7、测试</h3> <p>使用自定义<code>grant_type=sms_code</code>。</p> <p><img src="https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221005165003-52535a.png?x-oss-process=style/yuantu_shuiyin" alt="测试"></p> <p>该请求<code>curl</code>：</p> <div class="language- line-numbers-mode"><pre class="language-text"><code>curl --location --request POST 'http://127.0.0.1:3000/oauth/token' \
--header 'Authorization: Basic cmNiYjpyY2Ji' \
--header 'Content-Type: application/x-www-form-urlencoded' \
--data-urlencode 'grant_type=sms_code' \
--data-urlencode 'phone=13838384388' \
--data-urlencode 'verification_code=123456'
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>上面例子仅为梳理整个流程，还缺少业务逻辑上数据的校验。</p></div></div> <div class="page-slot page-slot-bottom"></br><ins class="adsbygoogle"
     style="display:block; text-align:center;"
     data-ad-layout="in-article"
     data-ad-format="auto"
     data-ad-client="ca-pub-8621788234752924"
     data-ad-slot="7043271566"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script></div> <div class="page-edit"><!----> <div class="tags"><a href="/tags/?tag=Spring%20Security" title="标签">#Spring Security</a></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">10/7/2022</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/0d4207/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">实战模块化(认证授权服务+资源服务)</div></a> <a href="/pages/9dc988/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">SpringBoot使用logback日志框架超详细教程</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/0d4207/" class="prev">实战模块化(认证授权服务+资源服务)</a></span> <span class="next"><a href="/pages/9dc988/">SpringBoot使用logback日志框架超详细教程</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/82530f/"><div>
            ChatGPT Plus订阅指南
            <!----></div></a> <span class="date">02-24</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/8b23f4/"><div>
            使用nvm控制node版本
            <!----></div></a> <span class="date">01-26</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/0e4b5e/"><div>
            git clone 报错：Filename too long
            <!----></div></a> <span class="date">01-26</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="https://github.com/rcbb-cc" title="Star我" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/playlist?id=5161366267" title="有品位的歌单" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2021-2024
    <span>日常bb | <a href="https://beian.miit.gov.cn/" target="_blank" style="font-weight:normal">鄂ICP备17023998号</a> </span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <!----> <!----></div><div class="global-ui"><!----><div></div></div></div>
    <script src="/assets/js/app.f183bd5e.js" defer></script><script src="/assets/js/2.ae7bab8c.js" defer></script><script src="/assets/js/30.b260e854.js" defer></script>
  </body>
</html>
