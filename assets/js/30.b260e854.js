(window.webpackJsonp=window.webpackJsonp||[]).push([[30],{372:function(e,n,s){"use strict";s.r(n);var t=s(1),a=Object(t.a)({},(function(){var e=this,n=e._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("h1",{attrs:{id:"spring-security-oauth2自定义授权模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#spring-security-oauth2自定义授权模式"}},[e._v("#")]),e._v(" Spring Security OAuth2自定义授权模式")]),e._v(" "),n("p",[e._v("在实际开发过程中"),n("code",[e._v("Spring Security OAuth2")]),e._v("默认提供的五种授权模式不够用的情况下，就需要我们自己来定义授权模式。")]),e._v(" "),n("p",[e._v("例如国内比较常见的应用场景：短信验证码授权登录。")]),e._v(" "),n("p",[n("a",{attrs:{href:"https://github.com/rcbb-cc/fast-start-guide",target:"_blank",rel:"noopener noreferrer"}},[e._v("SpringSecurity-demo Github地址"),n("OutboundLink")],1)]),e._v(" "),n("h2",{attrs:{id:"验证码登录"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证码登录"}},[e._v("#")]),e._v(" 验证码登录")]),e._v(" "),n("p",[e._v("其实实现这个需求有多种实现方式：")]),e._v(" "),n("p",[e._v("第一种：写一个"),n("code",[e._v("controller")]),e._v("接收登录，逻辑通过则在"),n("code",[e._v("controller")]),e._v("中组装"),n("code",[e._v("token")]),e._v("。")]),e._v(" "),n("p",[e._v("第二种：以"),n("code",[e._v("Spring Security")]),e._v("认证的思维，编写一个短信验证码的过滤器，配置在过滤器链上，加一个登录成功处理器，在登录成功后组装"),n("code",[e._v("token")]),e._v("。")]),e._v(" "),n("p",[e._v("这两种写法都可以实现短信验证码登录的这个需求，但是都不太规范。")]),e._v(" "),n("p",[e._v("规范写法：按照"),n("code",[e._v("Spring Security OAuth2")]),e._v("框架的的设计思想来完成自定义授权模式。")]),e._v(" "),n("p",[n("code",[e._v("Spring Security OAuth2")]),e._v("的授权思想和"),n("code",[e._v("Spring Security")]),e._v("有点区别：授权认证的时机不同。")]),e._v(" "),n("blockquote",[n("p",[n("code",[e._v("Spring Security OAuth2")]),e._v("是在请求进入"),n("code",[e._v("controller")]),e._v("后得到请求参数，然后使用"),n("code",[e._v("Spring Security OAuth2")]),e._v("提供的一些内置组件完成"),n("code",[e._v("token")]),e._v("的生成，而"),n("code",[e._v("Spring Security")]),e._v("则是依赖过滤器链来实现的，"),n("code",[e._v("Spring Security")]),e._v("是在请求未到达"),n("code",[e._v("controller")]),e._v("时，被匹配的过滤器拦截，然后进行认证，生成"),n("code",[e._v("token")]),e._v("。")])]),e._v(" "),n("h2",{attrs:{id:"实现思路"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实现思路"}},[e._v("#")]),e._v(" 实现思路")]),e._v(" "),n("p",[e._v("密码模式的授权流程：")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221005135820-4acf6c.png?x-oss-process=style/yuantu_shuiyin",alt:"密码模式的授权流程"}})]),e._v(" "),n("p",[e._v("重要知识点：")]),e._v(" "),n("ul",[n("li",[e._v("每种授权类型都对应一个实现类"),n("code",[e._v("TokenGranter")])]),e._v(" "),n("li",[e._v("所有"),n("code",[e._v("TokenGranter")]),e._v("实现类都通过"),n("code",[e._v("CompositeTokenGranter")]),e._v("中的"),n("code",[e._v("tokenGranters")]),e._v("集合存储")]),e._v(" "),n("li",[e._v("通过判断"),n("code",[e._v("grantType")]),e._v("参数来定位具体使用哪个"),n("code",[e._v("TokenGranter")]),e._v("实现类来处理")]),e._v(" "),n("li",[e._v("每种授权方式都对应一个"),n("code",[e._v("AuthenticationProvider")])]),e._v(" "),n("li",[n("code",[e._v("TokenGranter")]),e._v("类会"),n("code",[e._v("new")]),e._v("一个"),n("code",[e._v("AuthenticationToken")]),e._v("实现类传递给"),n("code",[e._v("ProviderManager")])])]),e._v(" "),n("p",[e._v("所以自定义一个授权类型，必须构建自己的"),n("code",[e._v("TokenGranter")]),e._v("、"),n("code",[e._v("AuthenticationProvider")]),e._v("、"),n("code",[e._v("AuthenticationToken")]),e._v("。")]),e._v(" "),n("h2",{attrs:{id:"验证码模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#验证码模式"}},[e._v("#")]),e._v(" 验证码模式")]),e._v(" "),n("h3",{attrs:{id:"_1、实现userdetailsservice"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、实现userdetailsservice"}},[e._v("#")]),e._v(" 1、实现"),n("code",[e._v("UserDetailsService")])]),e._v(" "),n("p",[e._v("后面主要填充的逻辑就是根据"),n("code",[e._v("phone")]),e._v("查询用户信息。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("@Service\npublic class SmsUserDetailsServiceImpl implements UserDetailsService {\n    @Override\n    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {\n        return null;\n    }\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br")])]),n("h3",{attrs:{id:"_2、自定义authenticationtoken"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、自定义authenticationtoken"}},[e._v("#")]),e._v(" 2、自定义"),n("code",[e._v("AuthenticationToken")])]),e._v(" "),n("p",[n("code",[e._v("SmsVerificationCodeAuthenticationToken")]),e._v("。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('public class SmsVerificationCodeAuthenticationToken extends AbstractAuthenticationToken {\n    private final Object principal;\n\n    public SmsVerificationCodeAuthenticationToken(Object principal) {\n        super(null);\n        this.principal = principal;\n        setAuthenticated(false);\n    }\n\n\n    public SmsVerificationCodeAuthenticationToken(Object principal, Collection<? extends GrantedAuthority> authorities) {\n        super(authorities);\n        this.principal = principal;\n        // 设置为已认证\n        super.setAuthenticated(true);\n    }\n\n    @Override\n    public Object getCredentials() {\n        return null;\n    }\n\n    @Override\n    public Object getPrincipal() {\n        return this.principal;\n    }\n\n    public void setAuthenticated(boolean isAuthenticated) throws IllegalArgumentException {\n        if (isAuthenticated) {\n            throw new IllegalArgumentException( "Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead");\n        }\n        super.setAuthenticated(false);\n    }\n\n    @Override\n    public void eraseCredentials() {\n        super.eraseCredentials();\n    }\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br"),n("span",{staticClass:"line-number"},[e._v("37")]),n("br"),n("span",{staticClass:"line-number"},[e._v("38")]),n("br"),n("span",{staticClass:"line-number"},[e._v("39")]),n("br")])]),n("h3",{attrs:{id:"_3、自定义tokengranter"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3、自定义tokengranter"}},[e._v("#")]),e._v(" 3、自定义"),n("code",[e._v("TokenGranter")])]),e._v(" "),n("p",[n("code",[e._v("SmsVerificationCodeTokenGranter")]),e._v("。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('@Slf4j\n@Slf4j\npublic class SmsVerificationCodeTokenGranter extends AbstractTokenGranter {\n\n    /**\n     * 授权类型，和password是一样的作用\n     */\n    private static final String grantType = "sms_code";\n\n    private final AuthenticationManager authenticationManager;\n\n    public SmsVerificationCodeTokenGranter(AuthenticationManager authenticationManager, AuthorizationServerTokenServices tokenServices, ClientDetailsService clientDetailsService, OAuth2RequestFactory requestFactory) {\n        this(authenticationManager, tokenServices, clientDetailsService, requestFactory, grantType);\n    }\n\n    protected SmsVerificationCodeTokenGranter(AuthenticationManager authenticationManager, AuthorizationServerTokenServices tokenServices, ClientDetailsService clientDetailsService, OAuth2RequestFactory requestFactory, String grantType) {\n        super(tokenServices, clientDetailsService, requestFactory, grantType);\n        this.authenticationManager = authenticationManager;\n    }\n\n    @Override\n    protected OAuth2Authentication getOAuth2Authentication(ClientDetails client, TokenRequest tokenRequest) {\n        // 得到请求参数\n        Map<String, String> parameters = new LinkedHashMap<>(tokenRequest.getRequestParameters());\n        // 手机号\n        String phone = parameters.get("phone");\n        // 验证码\n        String verificationCode = parameters.get("verification_code");\n        log.info("[登录请求 phone<{}> verificationCode<{}>]", phone, verificationCode);\n        \n        Authentication userAuth = new SmsVerificationCodeAuthenticationToken(parameters);\n        ((AbstractAuthenticationToken) userAuth).setDetails(parameters);\n        try {\n            // 调用authenticationManager进行认证，会根据SmsVerificationCodeAuthenticationToken找到对应的Provider\n            userAuth = authenticationManager.authenticate(userAuth);\n        } catch (AccountStatusException ase) {\n            //covers expired, locked, disabled cases (mentioned in section 5.2, draft 31)\n            throw new InvalidGrantException(ase.getMessage());\n        } catch (BadCredentialsException e) {\n            // If the username/password are wrong the spec says we should send 400/invalid grant\n            throw new InvalidGrantException(e.getMessage());\n        }\n        if (userAuth == null || !userAuth.isAuthenticated()) {\n            throw new InvalidGrantException("Could not authenticate user,phone number is: " + phone);\n        }\n        OAuth2Request storedOAuth2Request = getRequestFactory().createOAuth2Request(client, tokenRequest);\n        return new OAuth2Authentication(storedOAuth2Request, userAuth);\n    }\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br"),n("span",{staticClass:"line-number"},[e._v("37")]),n("br"),n("span",{staticClass:"line-number"},[e._v("38")]),n("br"),n("span",{staticClass:"line-number"},[e._v("39")]),n("br"),n("span",{staticClass:"line-number"},[e._v("40")]),n("br"),n("span",{staticClass:"line-number"},[e._v("41")]),n("br"),n("span",{staticClass:"line-number"},[e._v("42")]),n("br"),n("span",{staticClass:"line-number"},[e._v("43")]),n("br"),n("span",{staticClass:"line-number"},[e._v("44")]),n("br"),n("span",{staticClass:"line-number"},[e._v("45")]),n("br"),n("span",{staticClass:"line-number"},[e._v("46")]),n("br"),n("span",{staticClass:"line-number"},[e._v("47")]),n("br"),n("span",{staticClass:"line-number"},[e._v("48")]),n("br"),n("span",{staticClass:"line-number"},[e._v("49")]),n("br")])]),n("h3",{attrs:{id:"_4、自定义authenticationprovider"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4、自定义authenticationprovider"}},[e._v("#")]),e._v(" 4、自定义"),n("code",[e._v("AuthenticationProvider")])]),e._v(" "),n("p",[e._v("这个类就是真正的处理类，经过"),n("code",[e._v("TokenGranter")]),e._v("后，会找到对应的"),n("code",[e._v("AuthenticationProvider")]),e._v("。")]),e._v(" "),n("p",[n("code",[e._v("SmsVerificationCodeAuthenticationProvider")]),e._v("。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('@Slf4j\npublic class SmsVerificationCodeAuthenticationProvider implements AuthenticationProvider {\n\n    /**\n     * 得到UserDetailsService对象用来获取用户信息\n     */\n    private UserDetailsService userDetailsService;\n\n    public SmsVerificationCodeAuthenticationProvider(UserDetailsService userDetailsService) {\n        this.userDetailsService = userDetailsService;\n    }\n\n    public void setUserDetailsService(UserDetailsService userDetailsService) {\n        this.userDetailsService = userDetailsService;\n    }\n\n    /**\n     * 过请求参数查询数据库用户信息，进行匹配\n     *\n     * @param authentication the authentication request object.\n     * @return\n     * @throws AuthenticationException\n     */\n    @Override\n    public Authentication authenticate(Authentication authentication) throws AuthenticationException {\n        SmsVerificationCodeAuthenticationToken authenticationToken = (SmsVerificationCodeAuthenticationToken) authentication;\n        Map<String, String> parameters = (Map<String, String>) authenticationToken.getPrincipal();\n        log.info("[parameters <{}>]", parameters);\n        // 手机号\n        String phone = parameters.get("phone");\n        // 验证码\n        String verificationCode = parameters.get("verification_code");\n        log.info("[登录请求 phone<{}> verificationCode<{}>]", phone, verificationCode);\n        // 1.根据phone查询用户信息是否存在\n        // 2.判断验证码 是否有效\n\n        UserDetails user = new User("rcbb", "rcbb", true, true, true, true,\n                AuthorityUtils.commaSeparatedStringToAuthorityList("user_add,user_update,ROLE_ADMIN"));\n\n        SmsVerificationCodeAuthenticationToken smsVerificationCodeAuthenticationToken = new SmsVerificationCodeAuthenticationToken(user, user.getAuthorities());\n        smsVerificationCodeAuthenticationToken.setDetails(authenticationToken.getDetails());\n        return smsVerificationCodeAuthenticationToken;\n    }\n\n    @Override\n    public boolean supports(Class<?> authentication) {\n        // 判断authentication是否是SmsCodeAuthenticationToken类型\n        return SmsVerificationCodeAuthenticationToken.class.isAssignableFrom(authentication);\n    }\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br"),n("span",{staticClass:"line-number"},[e._v("37")]),n("br"),n("span",{staticClass:"line-number"},[e._v("38")]),n("br"),n("span",{staticClass:"line-number"},[e._v("39")]),n("br"),n("span",{staticClass:"line-number"},[e._v("40")]),n("br"),n("span",{staticClass:"line-number"},[e._v("41")]),n("br"),n("span",{staticClass:"line-number"},[e._v("42")]),n("br"),n("span",{staticClass:"line-number"},[e._v("43")]),n("br"),n("span",{staticClass:"line-number"},[e._v("44")]),n("br"),n("span",{staticClass:"line-number"},[e._v("45")]),n("br"),n("span",{staticClass:"line-number"},[e._v("46")]),n("br"),n("span",{staticClass:"line-number"},[e._v("47")]),n("br"),n("span",{staticClass:"line-number"},[e._v("48")]),n("br"),n("span",{staticClass:"line-number"},[e._v("49")]),n("br"),n("span",{staticClass:"line-number"},[e._v("50")]),n("br")])]),n("h3",{attrs:{id:"_5、将自定义的provider注入容器"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5、将自定义的provider注入容器"}},[e._v("#")]),e._v(" 5、将自定义的"),n("code",[e._v("Provider")]),e._v("注入容器")]),e._v(" "),n("p",[n("code",[e._v("SmsVerificationCodeAuthenticationConfig")]),e._v("。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("@Component\npublic class SmsVerificationCodeAuthenticationConfig extends SecurityConfigurerAdapter<DefaultSecurityFilterChain, HttpSecurity> {\n    @Autowired\n    private UserDetailsService userDetailsService;\n\n    @Override\n    public void configure(HttpSecurity builder) throws Exception {\n        SmsVerificationCodeAuthenticationProvider provider = new SmsVerificationCodeAuthenticationProvider(userDetailsService);\n        builder.authenticationProvider(provider);\n    }\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br")])]),n("p",[e._v("在"),n("code",[e._v("WebSecurityConfig")]),e._v("中，注入自定义的授权配置类。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("@Configuration\n@EnableWebSecurity\npublic class WebSecurityConfig extends WebSecurityConfigurerAdapter {\n\n    // 短信安全验证配置\n    @Autowired\n    private SmsVerificationCodeAuthenticationConfig smsVerificationCodeAuthenticationConfig;\n\n    @Override\n    protected void configure(HttpSecurity http) throws Exception {\n        http.apply(smsVerificationCodeAuthenticationConfig);\n    }\n    \n    ...\n}\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br")])]),n("h3",{attrs:{id:"_6、加到compositetokengranter集合中"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6、加到compositetokengranter集合中"}},[e._v("#")]),e._v(" 6、加到"),n("code",[e._v("CompositeTokenGranter")]),e._v("集合中")]),e._v(" "),n("p",[n("code",[e._v("clients")]),e._v("中的"),n("code",[e._v("authorizedGrantTypes")]),e._v("允许的授权类型添加"),n("code",[e._v("sms_code")]),e._v("。")]),e._v(" "),n("p",[e._v("将自定义的授权类型加到集合"),n("code",[e._v("CompositeTokenGranter")]),e._v("中。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('@Configuration\n@EnableAuthorizationServer\npublic class AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter {\n\n    @Override\n    public void configure(ClientDetailsServiceConfigurer clients) throws Exception {\n\n        // 基于内存便于测试，使用in-memory存储\n        clients.inMemory()\n                // client_id\n                .withClient("rcbb")\n                // 未加密\n                //.secret("secret")\n                // 加密\n                .secret(passwordEncoder.encode("rcbb"))\n                // 资源列表\n                //.resourceIds("res1")\n                // 该client允许的授权类型authorization_code,password,refresh_token,implicit,client_credentials\n                .authorizedGrantTypes("authorization_code", "password", "client_credentials", "implicit", "refresh_token","sms_code")\n                // 允许的授权范围\n                .scopes("all", "ROLE_ADMIN", "ROLE_USER")\n                // false跳转到授权页面\n                //.autoApprove(false)\n                //加上验证回调地址\n                .redirectUris("http://rcbb.cc");\n    }\n    \n    @Override\n    public void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {\n        List<TokenGranter> tokenGranters = new ArrayList<>(Collections.singleton(endpoints.getTokenGranter()));\n        tokenGranters.add(new SmsVerificationCodeTokenGranter(authenticationManager, tokenService(), clientDetailsService, new DefaultOAuth2RequestFactory(clientDetailsService)));\n\n        // 配置认证管理器\n        endpoints.authenticationManager(authenticationManager)\n                .tokenServices(tokenService())\n                .tokenGranter(new CompositeTokenGranter(tokenGranters));\n    }\n}\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br"),n("span",{staticClass:"line-number"},[e._v("17")]),n("br"),n("span",{staticClass:"line-number"},[e._v("18")]),n("br"),n("span",{staticClass:"line-number"},[e._v("19")]),n("br"),n("span",{staticClass:"line-number"},[e._v("20")]),n("br"),n("span",{staticClass:"line-number"},[e._v("21")]),n("br"),n("span",{staticClass:"line-number"},[e._v("22")]),n("br"),n("span",{staticClass:"line-number"},[e._v("23")]),n("br"),n("span",{staticClass:"line-number"},[e._v("24")]),n("br"),n("span",{staticClass:"line-number"},[e._v("25")]),n("br"),n("span",{staticClass:"line-number"},[e._v("26")]),n("br"),n("span",{staticClass:"line-number"},[e._v("27")]),n("br"),n("span",{staticClass:"line-number"},[e._v("28")]),n("br"),n("span",{staticClass:"line-number"},[e._v("29")]),n("br"),n("span",{staticClass:"line-number"},[e._v("30")]),n("br"),n("span",{staticClass:"line-number"},[e._v("31")]),n("br"),n("span",{staticClass:"line-number"},[e._v("32")]),n("br"),n("span",{staticClass:"line-number"},[e._v("33")]),n("br"),n("span",{staticClass:"line-number"},[e._v("34")]),n("br"),n("span",{staticClass:"line-number"},[e._v("35")]),n("br"),n("span",{staticClass:"line-number"},[e._v("36")]),n("br"),n("span",{staticClass:"line-number"},[e._v("37")]),n("br"),n("span",{staticClass:"line-number"},[e._v("38")]),n("br")])]),n("h3",{attrs:{id:"_7、测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7、测试"}},[e._v("#")]),e._v(" 7、测试")]),e._v(" "),n("p",[e._v("使用自定义"),n("code",[e._v("grant_type=sms_code")]),e._v("。")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221005165003-52535a.png?x-oss-process=style/yuantu_shuiyin",alt:"测试"}})]),e._v(" "),n("p",[e._v("该请求"),n("code",[e._v("curl")]),e._v("：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("curl --location --request POST 'http://127.0.0.1:3000/oauth/token' \\\n--header 'Authorization: Basic cmNiYjpyY2Ji' \\\n--header 'Content-Type: application/x-www-form-urlencoded' \\\n--data-urlencode 'grant_type=sms_code' \\\n--data-urlencode 'phone=13838384388' \\\n--data-urlencode 'verification_code=123456'\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br")])]),n("p",[e._v("上面例子仅为梳理整个流程，还缺少业务逻辑上数据的校验。")])])}),[],!1,null,null,null);n.default=a.exports}}]);