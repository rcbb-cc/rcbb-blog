(window.webpackJsonp=window.webpackJsonp||[]).push([[28],{371:function(s,n,e){"use strict";e.r(n);var a=e(1),t=Object(a.a)({},(function(){var s=this,n=s._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("h1",{attrs:{id:"实战-认证授权服务-资源服务"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#实战-认证授权服务-资源服务"}},[s._v("#")]),s._v(" 实战(认证授权服务+资源服务)")]),s._v(" "),n("p",[s._v("有了前面几篇文章的理论支持，是时候上实战了。")]),s._v(" "),n("p",[s._v("首先以单体的视角来进行集成，也就是认证服务和资源服务在一起，是一个单体项目。")]),s._v(" "),n("p",[n("a",{attrs:{href:"https://github.com/rcbb-cc/fast-start-guide",target:"_blank",rel:"noopener noreferrer"}},[s._v("auth-resources-demo Github地址"),n("OutboundLink")],1)]),s._v(" "),n("h2",{attrs:{id:"环境"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#环境"}},[s._v("#")]),s._v(" 环境")]),s._v(" "),n("p",[s._v("父类 pom 控制所有依赖版本。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<parent>\n\t<groupId>org.springframework.boot</groupId>\n\t<artifactId>spring-boot-starter-parent</artifactId>\n\t<version>2.7.4</version>\n\t<relativePath/>\n</parent>\n\n<properties>\n\t<java.version>11</java.version>\n\t<spring-boot.version>2.3.2.RELEASE</spring-boot.version>\n\t<spring-cloud.version>Hoxton.SR9</spring-cloud.version>\n\t<spring-cloud-alibaba.version>2.2.5.RELEASE</spring-cloud-alibaba.version>\n</properties>\n\n<dependencyManagement>\n\t<dependencies>\n\t\t\x3c!-- spring cloud alibaba 依赖 --\x3e\n\t\t<dependency>\n\t\t\t<groupId>com.alibaba.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-alibaba-dependencies</artifactId>\n\t\t\t<version>${spring-cloud-alibaba.version}</version>\n\t\t\t<type>pom</type>\n\t\t\t<scope>import</scope>\n\t\t</dependency>\n\t\t\x3c!-- spring cloud 依赖 --\x3e\n\t\t<dependency>\n\t\t\t<groupId>org.springframework.cloud</groupId>\n\t\t\t<artifactId>spring-cloud-dependencies</artifactId>\n\t\t\t<version>${spring-cloud.version}</version>\n\t\t\t<type>pom</type>\n\t\t\t<scope>import</scope>\n\t\t</dependency>\n\t</dependencies>\n</dependencyManagement>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br")])]),n("p",[s._v("子类依赖主要是"),n("code",[s._v("spring-boot-starter-web")]),s._v("和"),n("code",[s._v("spring-security-oauth2-autoconfigure")]),s._v("。\n通过微服务版本限定后"),n("code",[s._v("spring-security-oauth2-autoconfigure")]),s._v("的最终版本自动适配为2.1.2。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("<dependencies>\n\t<dependency>\n\t\t<groupId>org.springframework.boot</groupId>\n\t\t<artifactId>spring-boot-starter-web</artifactId>\n\t</dependency>\n\n\t<dependency>\n\t\t<groupId>org.springframework.boot</groupId>\n\t\t<artifactId>spring-boot-starter-test</artifactId>\n\t\t<scope>test</scope>\n\t</dependency>\n\t\x3c!--安全模块--\x3e\n\t<dependency>\n\t\t<groupId>org.springframework.security.oauth.boot</groupId>\n\t\t<artifactId>spring-security-oauth2-autoconfigure</artifactId>\n\t</dependency>\n\n\t\x3c!--server-api--\x3e\n\t<dependency>\n\t\t<groupId>javax.servlet</groupId>\n\t\t<artifactId>javax.servlet-api</artifactId>\n\t</dependency>\n</dependencies>\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br")])]),n("h2",{attrs:{id:"授权配置和测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#授权配置和测试"}},[s._v("#")]),s._v(" 授权配置和测试")]),s._v(" "),n("p",[s._v("需要什么配置就写什么配置，主要是梳理流程。")]),s._v(" "),n("h3",{attrs:{id:"_1、授权服务核心配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、授权服务核心配置"}},[s._v("#")]),s._v(" 1、授权服务核心配置")]),s._v(" "),n("p",[n("strong",[s._v("AuthorizationServerConfig")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("@Configuration\n@EnableAuthorizationServer\npublic class AuthorizationServerConfig extends AuthorizationServerConfigurerAdapter {\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("h3",{attrs:{id:"_2、spring-security-核心配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、spring-security-核心配置"}},[s._v("#")]),s._v(" 2、Spring Security 核心配置")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("@Configuration\n@EnableWebSecurity\npublic class WebSecurityConfig extends WebSecurityConfigurerAdapter {\n}\n\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br")])]),n("h3",{attrs:{id:"_3、访问测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3、访问测试"}},[s._v("#")]),s._v(" 3、访问测试")]),s._v(" "),n("blockquote",[n("p",[s._v("http://127.0.0.1:8080/oauth/authorize")])]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004013619-411c37.png?x-oss-process=style/yuantu_shuiyin",alt:"please sign in"}})]),s._v(" "),n("p",[s._v("任意输入账号密码，会提示账号或密码错误。")]),s._v(" "),n("h3",{attrs:{id:"_4、完善配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4、完善配置"}},[s._v("#")]),s._v(" 4、完善配置")]),s._v(" "),n("p",[n("code",[s._v("WebSecurityConfig")]),s._v("，因为重点是在于梳理流程，所以用户信息使用硬编码方式。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Bean\npublic PasswordEncoder passwordEncoder() {\n    return new BCryptPasswordEncoder();\n}\n\n@Autowired\npublic PasswordEncoder passwordEncoders() {\n    return new BCryptPasswordEncoder();\n}\n\n\n@Autowired\npublic void globalUserDetails(AuthenticationManagerBuilder auth) throws Exception {\n    // 配置全局用户信息\n    auth.inMemoryAuthentication().withUser("admin")\n            .password(passwordEncoders().encode("123456"))\n            .authorities(AuthorityUtils.commaSeparatedStringToAuthorityList("user_add,user_update,ROLE_ADMIN"));\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br")])]),n("p",[n("code",[s._v("AuthorizationServerConfig")]),s._v("，授权服配置端点信息。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Autowired\nprivate PasswordEncoder passwordEncoder;\n\n@Override\npublic void configure(ClientDetailsServiceConfigurer clients) throws Exception {\n    // 基于内存便于测试，使用in-memory存储\n    clients.inMemory()\n            // client_id\n            .withClient("rcbb")\n            // 未加密\n            //.secret("secret")\n            // 加密\n            .secret(passwordEncoder.encode("rcbb"))\n            // 资源列表\n            //.resourceIds("res1")\n            // 该client允许的授权类型authorization_code,password,refresh_token,implicit,client_credentials\n            .authorizedGrantTypes("authorization_code", "password", "client_credentials", "implicit", "refresh_token")\n            // 允许的授权范围\n            .scopes("all", "ROLE_ADMIN", "ROLE_USER")\n            // false跳转到授权页面\n            //.autoApprove(false)\n            //加上验证回调地址\n            .redirectUris("http://rcbb.cc");\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br")])]),n("h3",{attrs:{id:"_5、重启服务测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_5、重启服务测试"}},[s._v("#")]),s._v(" 5、重启服务测试")]),s._v(" "),n("p",[s._v("这次我们使用授权码方式进行测试，加上一些参数。")]),s._v(" "),n("p",[n("code",[s._v("response_type=code")]),s._v(" "),n("code",[s._v("client_id=rcbb")]),s._v(" "),n("code",[s._v("redirect_uri=http://rcbb.cc")]),s._v(" "),n("code",[s._v("scope=all")])]),s._v(" "),n("blockquote",[n("p",[s._v("http://127.0.0.1:8080/oauth/authorize?response_type=code&client_id=rcbb&redirect_uri=http://rcbb.cc&scope=all")])]),s._v(" "),n("p",[s._v("出现登录页面，输入我们"),n("code",[s._v("WebSecurityConfig")]),s._v("配置的用户信息"),n("code",[s._v("admin/123456")]),s._v("。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004014830-c4157d.png?x-oss-process=style/yuantu_shuiyin",alt:"OAuth Approval"}})]),s._v(" "),n("p",[s._v("然后就会成功，并且让我们选择是否授权。")]),s._v(" "),n("p",[s._v("授权成功后，会跳到对应的网址，并且"),n("code",[s._v("url")]),s._v("会接上我们所需的"),n("code",[s._v("code")]),s._v("。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004014959-1e0611.png?x-oss-process=style/yuantu_shuiyin",alt:"rcbb"}})]),s._v(" "),n("p",[s._v("拿到授权码后，进行获取"),n("code",[s._v("token")]),s._v("的测试。我使用的是"),n("code",[s._v("PostMan")]),s._v("工具进行测试。")]),s._v(" "),n("p",[s._v("首先需要在"),n("code",[s._v("Authorization")]),s._v("上选择对应的"),n("code",[s._v("Type")]),s._v("并填上"),n("code",[s._v("AuthorizationServerConfig")]),s._v("中配置的"),n("code",[s._v("client")]),s._v("信息。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004015233-f9032b.png?x-oss-process=style/yuantu_shuiyin",alt:"postman"}})]),s._v(" "),n("p",[s._v("然后"),n("code",[s._v("Body")]),s._v("体以"),n("code",[s._v("x-www-form-urlencoded")]),s._v("的方式，填上对应的参数。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004015517-e409e1.png?x-oss-process=style/yuantu_shuiyin",alt:"postman"}})]),s._v(" "),n("p",[s._v("请求的"),n("code",[s._v("curl")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("curl --location --request POST 'http://127.0.0.1:8080/oauth/token' \\\n--header 'Authorization: Basic cmNiYjpyY2Ji' \\\n--header 'Content-Type: application/x-www-form-urlencoded' \\\n--data-urlencode 'grant_type=authorization_code' \\\n--data-urlencode 'code=fB3uZl' \\\n--data-urlencode 'redirect_uri=http://rcbb.cc' \\\n--data-urlencode 'scope=all' \\\n--data-urlencode 'client_id=rcbb'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br")])]),n("p",[s._v("测试成功，成功获取"),n("code",[s._v("token")]),s._v("。")]),s._v(" "),n("h3",{attrs:{id:"_6、配置密码模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_6、配置密码模式"}},[s._v("#")]),s._v(" 6、配置密码模式")]),s._v(" "),n("p",[s._v("使用密码模式，发现并不支持。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004142423-fc98c1.png?x-oss-process=style/yuantu_shuiyin",alt:"不支持密码模式"}})]),s._v(" "),n("p",[n("code",[s._v("WebSecurityConfig")]),s._v("补充配置认证管理器"),n("code",[s._v("AuthenticationManager")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("@Bean\npublic AuthenticationManager authenticationManagerBean() throws Exception {\n\treturn super.authenticationManagerBean();\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br")])]),n("p",[n("code",[s._v("AuthorizationServerConfig")]),s._v("补充配置密码模式。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("@Autowired\nprivate AuthenticationManager authenticationManager;\n\n/**\n * 配置令牌的访问端点和令牌服务\n *\n * @param endpoints the endpoints configurer\n * @throws Exception\n */\n@Override\npublic void configure(AuthorizationServerEndpointsConfigurer endpoints) throws Exception {\n    // 配置认证管理器\n    endpoints.authenticationManager(authenticationManager);\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br")])]),n("p",[s._v("重启服务进行测试。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004142914-84323b.png?x-oss-process=style/yuantu_shuiyin",alt:"通过密码获取token"}})]),s._v(" "),n("p",[s._v("请求的"),n("code",[s._v("curl")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("curl --location --request POST 'http://127.0.0.1:8080/oauth/token' \\\n--header 'Authorization: Basic cmNiYjpyY2Ji' \\\n--header 'Content-Type: application/x-www-form-urlencoded' \\\n--data-urlencode 'grant_type=password' \\\n--data-urlencode 'username=admin' \\\n--data-urlencode 'password=123456'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h3",{attrs:{id:"_7、测试简化模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_7、测试简化模式"}},[s._v("#")]),s._v(" 7、测试简化模式")]),s._v(" "),n("p",[s._v("请求参数：")]),s._v(" "),n("p",[n("code",[s._v("response_type=token")]),s._v(" "),n("code",[s._v("client_id=rcbb")]),s._v(" "),n("code",[s._v("redirect_uri=http://rcbb.cc")]),s._v(" "),n("code",[s._v("scope=all")])]),s._v(" "),n("blockquote",[n("p",[s._v("http://127.0.0.1:8080/oauth/authorize?response_type=token&client_id=rcbb&redirect_uri=http://rcbb.cc&scope=all")])]),s._v(" "),n("p",[s._v("授权成功后，"),n("code",[s._v("token")]),s._v("的信息直接返回在"),n("code",[s._v("url")]),s._v("上了。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004143415-821ef8.png?x-oss-process=style/yuantu_shuiyin",alt:"简化模式"}})]),s._v(" "),n("h3",{attrs:{id:"_8、测试客户端模式"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_8、测试客户端模式"}},[s._v("#")]),s._v(" 8、测试客户端模式")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004144548-f17da0.png?x-oss-process=style/yuantu_shuiyin",alt:"客户端模式"}})]),s._v(" "),n("p",[s._v("请求的"),n("code",[s._v("curl")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("curl --location --request POST 'http://127.0.0.1:8080/oauth/token' \\\n--header 'Authorization: Basic cmNiYjpyY2Ji' \\\n--header 'Content-Type: application/x-www-form-urlencoded' \\\n--data-urlencode 'grant_type=client_credentials' \\\n--data-urlencode 'client_id=rcbb' \\\n--data-urlencode 'client_secret=rcbb'\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br")])]),n("h2",{attrs:{id:"认证授权配置和测试"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#认证授权配置和测试"}},[s._v("#")]),s._v(" 认证授权配置和测试")]),s._v(" "),n("h3",{attrs:{id:"_1、创建测试资源"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_1、创建测试资源"}},[s._v("#")]),s._v(" 1、创建测试资源")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@RestController\n@RequestMapping("/user")\npublic class UserController {\n\n    @PostMapping\n    public String save() {\n        return "save() success";\n    }\n\n    @PutMapping\n    public String update() {\n        return "update() success";\n    }\n\n    @GetMapping\n    public String list() {\n        return "list() success";\n    }\n    \n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br")])]),n("p",[s._v("三个请求：")]),s._v(" "),n("ul",[n("li",[s._v("post:/user 新增用户信息")]),s._v(" "),n("li",[s._v("put:/user 修改用户信息")]),s._v(" "),n("li",[s._v("get:/user 获取用户信息")])]),s._v(" "),n("h3",{attrs:{id:"_2、获取token后访问资源"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_2、获取token后访问资源"}},[s._v("#")]),s._v(" 2、获取"),n("code",[s._v("token")]),s._v("后访问资源")]),s._v(" "),n("p",[s._v("先获取"),n("code",[s._v("token")]),s._v("。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004145358-34f5e4.png?x-oss-process=style/yuantu_shuiyin",alt:"通过密码获取token"}})]),s._v(" "),n("p",[s._v("虽然请求中携带了"),n("code",[s._v("token")]),s._v("值，但是还是"),n("code",[s._v("401 Unauthorized")]),s._v("。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004145452-19d863.png?x-oss-process=style/yuantu_shuiyin",alt:"401 Unauthorized"}})]),s._v(" "),n("p",[s._v("这是为啥？？？")]),s._v(" "),n("p",[s._v("正常情况下，认证授权服务和资源服务是分开的。")]),s._v(" "),n("p",[s._v("正常认证授权服务是接管"),n("code",[s._v("/oauth/token")]),s._v("、"),n("code",[s._v("/oauth/token_key")]),s._v("、"),n("code",[s._v("/oauth/check_token")]),s._v("，这三个请求，也就是这三个请求会被"),n("code",[s._v("Spring Security OAuth2")]),s._v("处理。")]),s._v(" "),n("p",[s._v("然后我们自己写的资源应该是在资源服务上，例如"),n("code",[s._v("/user")]),s._v("请求就会被"),n("code",[s._v("Spring Security")]),s._v("处理。")]),s._v(" "),n("p",[s._v("那这种单体情况，如何处理？")]),s._v(" "),n("h3",{attrs:{id:"_3、新增资源服务配置"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_3、新增资源服务配置"}},[s._v("#")]),s._v(" 3、新增资源服务配置")]),s._v(" "),n("p",[s._v("认证授权服务和资源服务写在一起。")]),s._v(" "),n("p",[n("code",[s._v("ResourceServerConfig")]),s._v("资源服务配置。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v("@Configuration\n@EnableResourceServer\n// 开启注解鉴权\n@EnableGlobalMethodSecurity(securedEnabled = true, prePostEnabled = true)\npublic class ResourceServerConfig extends ResourceServerConfigurerAdapter {\n\n    //配置资源服安全规则\n    @Override\n    public void configure(HttpSecurity http) throws Exception {\n        http\n                // 授权的请求\n                .authorizeRequests()\n                // 任何请求\n                .anyRequest()\n                // 需要身份认证\n                .authenticated()\n                .and().csrf().disable();\n    }\n}\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br")])]),n("p",[s._v("重启服务，再次请求。"),n("code",[s._v("token")]),s._v("错误。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004150634-9513dd.png?x-oss-process=style/yuantu_shuiyin",alt:"invalid_token"}})]),s._v(" "),n("p",[s._v("因为默认"),n("code",[s._v("token")]),s._v("是存在内存中（可以配置存储在MySQL、Redis中）的，所以这里重新获取一次"),n("code",[s._v("token")]),s._v("就行了。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004150754-7a4c09.png?x-oss-process=style/yuantu_shuiyin",alt:"请求成功"}})]),s._v(" "),n("h3",{attrs:{id:"_4、给资源添加权限"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#_4、给资源添加权限"}},[s._v("#")]),s._v(" 4、给资源添加权限")]),s._v(" "),n("p",[n("code",[s._v('@Secured("ROLE_ADMIN")')]),s._v("：专门用于判断是否具有角色。")]),s._v(" "),n("p",[n("code",[s._v("@PreAuthorize(\"hasAuthority('user_add')\")")]),s._v("即可判断权限，也可以判断身份，还可以使用正则判断。"),n("br"),s._v("\n如果是判断身份，那么需要填写"),n("code",[s._v("@PreAuthorize(\"hasRole('ROLE_ADMIN')\")")]),s._v("。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@RestController\n@RequestMapping("/user")\npublic class UserController {\n\n    @PreAuthorize("hasAuthority(\'user_add\')")\n    @PostMapping\n    public String save() {\n        return "save() success";\n    }\n\n    @PreAuthorize("hasAuthority(\'user_remove\')")\n    @DeleteMapping\n    public String remove() {\n        return "remove() success";\n    }\n\n    @PreAuthorize("hasAuthority(\'user_update\')")\n    @PutMapping\n    public String update() {\n        return "update() success";\n    }\n\n    @Secured("ROLE_ADMIN")\n    @GetMapping\n    public String list() {\n        return "list() success";\n    }\n\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br")])]),n("p",[s._v("我们目前的用户信息是在"),n("code",[s._v("WebSecurityConfig")]),s._v("硬编码配置的。")]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('@Autowired\npublic void globalUserDetails(AuthenticationManagerBuilder auth) throws Exception {\n\t// 配置全局用户信息\n\tauth.inMemoryAuthentication().withUser("admin")\n\t\t\t.password(passwordEncoders().encode("123456"))\n\t\t\t.authorities(AuthorityUtils.commaSeparatedStringToAuthorityList("user_add,user_update,ROLE_ADMIN"));\n}\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("p",[s._v("所以对应上面的资源所需权限，"),n("code",[s._v("DELETE:/user")]),s._v("是无法访问的。")]),s._v(" "),n("p",[n("img",{attrs:{src:"https://rcbb-blog.oss-cn-guangzhou.aliyuncs.com/2022/10/20221004154304-9c35f3.png?x-oss-process=style/yuantu_shuiyin",alt:"无法访问"}})]),s._v(" "),n("p",[s._v("其他资源可正常访问。")])])}),[],!1,null,null,null);n.default=t.exports}}]);